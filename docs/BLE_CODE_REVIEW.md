# –û–≥–ª—è–¥ –∫–æ–¥—É BLE –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

## ‚úÖ –í–∏—è–≤–ª–µ–Ω—ñ —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏:

### 1. **Mock BLE –Ω–µ –æ–Ω–æ–≤–ª—é–≤–∞–≤ connectionStore** ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤—Å—è mock —Ä–µ–∂–∏–º, –≥–ª–æ–±–∞–ª—å–Ω–∏–π `connectionStore` –Ω–µ –∑–Ω–∞–≤ –ø—Ä–æ —Å—Ç–∞–Ω –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
- –î–æ–¥–∞–Ω–æ —ñ–º–ø–æ—Ä—Ç `connectionStore` –≤ `MockBleProvider.tsx`
- –î–æ–¥–∞–Ω–æ `useEffect` —â–æ –æ–Ω–æ–≤–ª—é—î —Å—Ç–∞–Ω: `connectionStore.updateBle(linkUp, isReconnecting)`

**–§–∞–π–ª:** `src/hooks/MockBleProvider/MockBleProvider.tsx:115-117`

### 2. **UUID case sensitivity** ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û
**–ü—Ä–æ–±–ª–µ–º–∞:** UUID –ø–æ—Ä—ñ–≤–Ω—é–≤–∞–≤—Å—è –∑ `.toLowerCase()` –∞–ª–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –º–æ–≥–ª–∞ –±—É—Ç–∏ –≤ —Ä—ñ–∑–Ω–∏—Ö —Ä–µ–≥—ñ—Å—Ç—Ä–∞—Ö.

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
- –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è UUID –¥–æ lowercase –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: `const TARGET_SERVICE = BLE_DEVICE.SERVICE_UUID.toLowerCase()`

**–§–∞–π–ª:** `src/hooks/useScanDevices.ts:35`

### 3. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ Internet** ‚úÖ –ù–ï –ü–†–û–ë–õ–ï–ú–ê
**–ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ:** NetInfo.addEventListener() –≤ useGlobalConnectionMonitor - —Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ö–æ–∂–Ω–∞ –ø—ñ–¥–ø–∏—Å–∫–∞ —É–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –æ–∫—Ä–µ–º–æ —ñ –æ—á–∏—â–∞—î—Ç—å—Å—è –≤ cleanup.

## üìã –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ –ª–æ–≥—ñ—Ü—ñ:

### BLE –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è (useBleScan):
‚úÖ –°–∫–∞–Ω—É–≤–∞–Ω–Ω—è 10 —Å–µ–∫—É–Ω–¥ (BLE_TIMEOUTS.SCAN_DURATION)
‚úÖ –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø–æ —ñ–º–µ–Ω—ñ "Hybit NeuraFlow" —Ç–∞ SERVICE_UUID
‚úÖ Timeout –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (10 —Å–µ–∫)
‚úÖ –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Å–µ—Ä–≤—ñ—Å—ñ–≤ –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
‚úÖ –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–∞–ª—å–Ω–∏–π backoff –¥–ª—è —Ä–µ–∫–æ–Ω–µ–∫—Ç—É (1s ‚Üí 2s ‚Üí 4s ‚Üí 8s ‚Üí 16s)
‚úÖ –ú–∞–∫—Å–∏–º—É–º 3 —Å–ø—Ä–æ–±–∏ —Ä–µ–∫–æ–Ω–µ–∫—Ç—É
‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ deviceId –¥–ª—è auto-reconnect
‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è connectionStore –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–∞–Ω—É

### Mock BLE (useMockBleScan):
‚úÖ –°–∏–º—É–ª—è—Ü—ñ—è —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é 2 —Å–µ–∫
‚úÖ –°–∏–º—É–ª—è—Ü—ñ—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é 1.5 —Å–µ–∫
‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è mock –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ mockCoaster
‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è deviceId
‚úÖ **–í–ò–ü–†–ê–í–õ–ï–ù–û:** –û–Ω–æ–≤–ª–µ–Ω–Ω—è connectionStore

### BLE Connection (useBLEConnection):
‚úÖ –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ RX —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
‚úÖ Base64 –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è/–∫–æ–¥—É–≤–∞–Ω–Ω—è
‚úÖ –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü—ñ—è –ª—ñ–Ω—ñ–π –∑ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è–º \r\n|\n|\r
‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ DL –ª—ñ–Ω—ñ–π (—ñ–Ω–¥–µ–∫—Å + –º–ª)
‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ DEV –ª—ñ–Ω—ñ–π (–±–∞—Ç–∞—Ä–µ—è)
‚úÖ Deduplica —Ü—ñ—è –ø–æ —ñ–Ω–¥–µ–∫—Å—É (seenIndicesRef)
‚úÖ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ TX —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É
‚úÖ Fallback: writeWithResponse ‚Üí writeWithoutResponse

### Connection Monitor:
‚úÖ –ì–ª–æ–±–∞–ª—å–Ω–∏–π singleton store (connectionStore)
‚úÖ –†–µ–∞–∫—Ç–∏–≤–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –ø—ñ–¥–ø–∏—Å–∫–∏
‚úÖ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ Internet —á–µ—Ä–µ–∑ NetInfo
‚úÖ –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è BLE —Å—Ç–∞–Ω—É (isConnected, isReconnecting)
‚úÖ –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è Coaster —Å—Ç–∞–Ω—É
‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ hasAllConnections
‚úÖ –°–ø–∏—Å–æ–∫ missingConnections
‚úÖ canStartRace –ø—Ä–∞–ø–æ—Ä–µ—Ü—å

### Connection Alerts:
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑'—è–≤–ª–µ–Ω–Ω—è/–∑–Ω–∏–∫–Ω–µ–Ω–Ω—è
‚úÖ –ü–æ–∫–∞–∑ —Ä–µ–∫–æ–Ω–µ–∫—Ç—É (üîÑ –ü–µ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç –¥–æ Bluetooth...)
‚úÖ –û–±—Ä–æ–±–∫–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
‚úÖ –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ useGlobalConnectionMonitor

### Connection Guard:
‚úÖ –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
‚úÖ –ü–æ–∫–∞–∑ —Å–ø–∏—Å–∫—É –≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
‚úÖ useCanStartRace —Ö—É–∫

## üîß –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ BLE:

```typescript
BLE_DEVICE = {
  TARGET_NAME: "Hybit NeuraFlow",
  SERVICE_UUID: "6e400001-b5a3-f393-e0a9-e50e24dcca9e", // Nordic UART
  RX_CHARACTERISTIC: "6e400003-b5a3-f393-e0a9-e50e24dcca9e",
  TX_CHARACTERISTIC: "6e400002-b5a3-f393-e0a9-e50e24dcca9e",
}

BLE_TIMEOUTS = {
  SCAN_DURATION: 10000,              // 10 —Å–µ–∫
  CONNECTION_TIMEOUT: 10000,         // 10 —Å–µ–∫
  RECONNECT_INITIAL_DELAY: 1000,     // 1 —Å–µ–∫
  RECONNECT_MAX_DELAY: 30000,        // 30 —Å–µ–∫
  MAX_RECONNECT_ATTEMPTS: 3,         // 3 —Å–ø—Ä–æ–±–∏
  BACKFILL_STABILIZATION_DELAY: 500, // 500 –º—Å
  PROTOCOL_IDLE_TIMEOUT: 3000,       // 3 —Å–µ–∫
  AUTO_SYNC_DELAY: 250,              // 250 –º—Å
}
```

## üéØ –§–ª–æ—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:

1. **–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è:**
   - startScan() ‚Üí 10 —Å–µ–∫ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è
   - –§—ñ–ª—å—Ç—Ä –ø–æ —ñ–º–µ–Ω—ñ + UUID
   - –ó–Ω–∞–π–¥–µ–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó ‚Üí devices[]

2. **–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:**
   - connectToDevice(deviceId)
   - Timeout 10 —Å–µ–∫
   - discoverAllServicesAndCharacteristics()
   - –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è SERVICE_UUID
   - –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ RX
   - –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è deviceId
   - –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ disconnect event
   - ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è connectionStore

3. **–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (Unexpected):**
   - onDeviceDisconnected() callback
   - setLinkUp(false)
   - setIsReconnecting(true)
   - scheduleReconnect(deviceId, 0)
   - ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è connectionStore

4. **–†–µ–∫–æ–Ω–µ–∫—Ç:**
   - –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–∞–ª—å–Ω–∏–π backoff
   - –°–ø—Ä–æ–±–∞ 1: 1 —Å–µ–∫
   - –°–ø—Ä–æ–±–∞ 2: 2 —Å–µ–∫
   - –°–ø—Ä–æ–±–∞ 3: 4 —Å–µ–∫
   - –Ø–∫—â–æ –≤—Å—ñ failed ‚Üí setIsReconnecting(false)

5. **Mock —Ä–µ–∂–∏–º:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞—Ö
   - –ê–±–æ BLE_CONFIG.USE_MOCK_BLE = true
   - –®–≤–∏–¥–∫–µ "—Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è" (2 —Å–µ–∫)
   - –®–≤–∏–¥–∫–µ "–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è" (1.5 —Å–µ–∫)
   - Mock –¥–∞–Ω—ñ —á–µ—Ä–µ–∑ mockCoaster
   - ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è connectionStore

## ‚úÖ –í–∏—Å–Ω–æ–≤–æ–∫:

–í—Å—ñ –æ—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –ø—Ä–∞—Ü—é—é—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–æ:
- ‚úÖ BLE —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è —Ç–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
- ‚úÖ –†–µ–∫–æ–Ω–µ–∫—Ç –ª–æ–≥—ñ–∫–∞
- ‚úÖ Mock —Ä–µ–∂–∏–º
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ –†–µ–∞–∫—Ç–∏–≤–Ω—ñ –∞–ª–µ—Ä—Ç–∏
- ‚úÖ –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- Mock BLE —Ç–µ–ø–µ—Ä –æ–Ω–æ–≤–ª—é—î connectionStore
- UUID –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –¥–æ lowercase

–ö–æ–¥ –≥–æ—Ç–æ–≤–∏–π –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è! üöÄ
